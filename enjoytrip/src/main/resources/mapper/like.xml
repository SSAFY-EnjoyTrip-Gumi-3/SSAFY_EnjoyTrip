<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.trip.model.dao.LikeDao">

	<!-- 좋아요 수 집계  -->
	<select id="countLikesByAttraction" resultType="long">
		SELECT COUNT(*)
		FROM place_group_items
		WHERE attraction_no = #{attractionNo}
	</select>
	
	<!-- 좋아요 추가 -->
	<insert id="insertLike">
		INSERT INTO place_group_items(group_no, attraction_no)
			SELECT pg.group_no, #{attractionNo}
      		FROM place_groups pg
    		WHERE pg.user_no = #{userNo}
       		AND pg.group_name = #{groupName}
	</insert>
	
	<!-- 좋아요 취소 -->
	<delete id="deleteLike">
		DELETE FROM place_group_items
		WHERE attraction_no = #{attractionNo}
		AND group_no = (
			SELECT group_no
			FROM place_groups
			WHERE user_no = #{userNo}
			<if test="groupName != null and groupName != ''">
				AND group_name = #{groupName}
			</if>
		)
	</delete>
	
	<!-- 좋아요 존재 여부 확인 -->
	<select id="existsLike">
		SELECT count(*)
		FROM place_group_items pgi
		JOIN place_groups pg ON pgi.group_no = pg.group_no
		<where>
			pg.user_no = #{userNo}
		 	AND pgi.attraction_no = #{attractionNo}
			<if test="groupName != null and groupName != ''">
				AND pg.group_name = #{groupName}
			</if>
		</where>
	</select>
	
	<!-- 다중 그룹으로 조회 예시 -->
	<select id="selectLikedAttractions" resultMap="com.ssafy.trip.model.dao.AttractionDao.attractionMap">
		SELECT a.*
		FROM place_groups pg
		JOIN place_group_items pgi ON pg.group_no = pgi.group_no
		JOIN attraction a ON pgi.attraction_no = a.attraction_no
		<where>
			pg.user_no = #{userNo}
			<if test="groupName != null and !groupName.isEmpty()">
				AND pg.group_name IN
				<foreach item="g" collection="groupName" open="(" separator="," close=")">
					#{g}
				</foreach>
			</if>
		</where>
	</select>
	
  <resultMap id="PopularAttractionMap" type="com.ssafy.trip.model.dto.PopularAttractionDTO">
    <id column="attraction_no"        property="attractionNo"/>
    <result column="title"            property="title"/>
    <result column="first_image1"     property="firstImage1"/>
    <result column="latitude"         property="latitude"/>
    <result column="longitude"        property="longitude"/>
    <result column="like_count"       property="likeCount"/>
    <result column="overview"       property="overview"/>
    <result column="addr1"       property="addr1"/>
  </resultMap>

  <select id="selectPopularAttractions" resultMap="PopularAttractionMap">
    SELECT 
      a.attraction_no,
      a.title,
      a.first_image1,
      a.latitude,
      a.longitude,
      a.overview,
      a.addr1,
      COUNT(pgi.attraction_no) AS like_count
    FROM place_group_items pgi
    JOIN attractions a
      ON pgi.attraction_no = a.attraction_no
    GROUP BY a.attraction_no, a.title, a.first_image1, a.latitude, a.longitude, a.overview, a.addr1
    ORDER BY like_count DESC
  </select>
</mapper>